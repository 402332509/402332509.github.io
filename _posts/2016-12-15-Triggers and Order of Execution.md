---
date: 2016-12-15 14:12:56
layout: post
title: 触发器和执行顺序
thread: 1002
categories: 日志
tags: Salesforce Apex
---


当你用insert,update或upset语句来保存一条记录时，Salesforce平台会按顺序执行下面的事件。

---

当Salesforce在服务器上执行这些事件之前，浏览器会执行JavaScript校验来判断是否有记录包含依赖字段。这个校验限制了每个依赖字段到它可获取的值。除此之外，客户端没有其他校验发生。

---

1. 在服务器端，Salesforce会：
2. 从数据库加载原始记录或从upsert语句中初始化记录。
 从请求中加载最新记录的字段值并重写旧值。
 如果请求来自于标准的编辑页面，Salesforce会	运行系统校验来检查记录：
 - 遵从布局指定的规则
 - 布局和字段定义上的必填项
 - 校验字段格式
 - 字段的最大长度
 当请求发自其他来源时，比如Apex应用或SOAP API调用， Salesforce只会校验外键。在执行触发器之前，Salesforce会检查自定义外键是否指向非当前对象。
 当多行项目被创建时（比如报价行项目和业务机会航项目），Salesforce会运行用户定义的验证规则。
3. 执行所有before触发器。
4. 再次执行大部分系统校验步骤，比如校验必填字段是否有空值，并运行所有的用户定义的验证规则。Salesforce唯一不运行二次的系统校验是布局指定的规则。（当请求来自标准编辑页面时）
5. 执行重复检查。如果检查将记录识别为重复那么将会阻塞改动作，这条记录不会被保存也不会执行接下来的步骤，比如after触发器和工作流。
6. 保存记录到数据库，但暂时不会提交。
7. 执行所有的after触发器
8. 执行分配规则。
9. 执行自动响应规则。
10. 执行工作流。
11. 如果有工作流更新字段，会再次更新这条记录。
12. 如果记录是被工作流更新字段操作更新的，再次执行before update和after update触发器（只会再次执行一次），除了标准的校验之外。自定义验证规则，重复校验和升级规则不会再次运行。
13. 执行进程。
 如果有工作流触发器，执行流。
 The pilot program for flow trigger workflow actions is closed. 
 如果你在你的组织中已经启用了试点，你可以继续创建和编辑流触发工作流。如果你没有启用试点，你可以用进程生成器中的流操作来替代。
14. 执行升级规则
15. 执行投票规则
16. 如果记录包含有汇总字段或是跨对象工作流的一部分时，在父记录中计算并更新汇总字段。父记录会走保存流程。
17. 如果祖父记录更新了，并且祖父记录包含汇总字段或是跨对象工作流的一部分时，计算并更新祖父记录中的汇总字段。祖父记录会走保存流程。
18. 执行共享规则。
19. 提交所有DML操作到数据库。
20. 执行提交前逻辑，比如发邮件。

---

递归保存时，Salesforce会跳过第8步（分配规则）到17步（祖父记录中的汇总字段）

---

### 额外考虑
请注意一下几点当你使用触发器时。
当同一个对象有多个触发器
